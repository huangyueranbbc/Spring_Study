define("common:widget/ui/comment/comment.js",function(e,t,a){var i=e("common:widget/ui/dialog/dialog.js"),o=e("common:widget/lib/webuploader/webuploader.js"),n=function(){var e=66,t=410,a=620,n=10485760,s=43,r=43,c=500,l={detail:"/uc/comment/detail",submit:"/uc/comment/submit"},d=null,u=null,m=null,p=null,f=null,v=null,h=null,g=!1,w=null,b=null,_=0,x=[],j="http://newpc0.nuomi.bdimg.com/static/common/$1.swf",C="http://newpc1.nuomi.bdimg.com/static/common/widget/ui/comment/img/upload-failure_4a61605.png",k="http://newpc2.nuomi.bdimg.com/static/common/widget/ui/comment/img/load_46b3216.gif",y=8,I={file_size_exceed:"每张图片不超过10M，请压缩图片后重新上传！",content:"您输入的字数超过了500字,请删除一些！",score:"请输入总体评价！",upload:"图片还没有全部上传完！",file_count_exceed:"最多只能选择8张图片"},S={isUploadPic:!1,isSuccess:!1},F={all:{name:"总体评分",desc:["很差","差","一般","很好","非常好"]}},z={catg_ids:"",dealId:"",orderId:"",score:0,content:"",pic_list:{},item:{}},A=function(e){$.extend(z,e||{})},P=function(e){var t=z.score;if(1==e&&0!=t){var a=$("#j-overral-comment a");a.each(function(e,a){t>=e+1&&$(a).addClass("click-star")});var i=F.all.desc[t-1];$("#j-score-all").text(i)}},T=function(e,t,a){var o={width:e,title:a||"提示",content:t};b=new i(o),b.center()},U=function(){m=$("#j-text-area"),p=$("#j-word-number"),f=$("#j-word-tip"),v=$("#j-word-limit"),u=$("#j-pic-gallery"),d=$("#j-upload-pic"),h=$("#j-error-info"),w=$("#j-submit-comment")},D=function(e){var t=e.attr("data-item"),a=t.split("_"),i=a[0],o=a[1];"all"==i?z.score=o:z.item[i]=o;var n=$("#j-score-"+i);n.text(F[i].desc[o-1])},N=function(){var e=$("#j-star-level a");e.on("mouseenter",function(){var e=$(this),t="hover-star";e.hasClass("star")||(t="hover-star-s"),e.addClass(t),e.prevAll().addClass(t),e.nextAll().removeClass(t)}),e.on("mouseleave",function(){var e=$(this),t="hover-star";e.hasClass("star")||(t="hover-star-s"),e.siblings().removeClass(t),e.removeClass(t)}),e.on("click",function(){var e=$(this),t="click-star";e.hasClass("star")||(t="click-star-s"),e.addClass(t),e.prevAll().addClass(t),e.nextAll().removeClass(t),D(e)})},O=function(){m.on({keyup:function(){G()},paste:function(){G()}})},E=function(){var t=$("#j-comment-label");t.height()>e&&t.addClass("label-hidden")},G=function(){var e=m.val(),t=e.length,a=c-t;if(0>=a){v.show(),f.hide();var i=e.substr(0,c);m.val(i)}else f.show(),v.hide(),p.text(a)},J=function(){var e=$("#j-comment-label a");e.on("click",function(){var e=$(this),t=e.find(".item").text(),a=t+" ",i=m.val(),o=i.length,n=a.length,s=o+n;if(!(o>=c||s>c)){var r=i.replace(t,"");if(e.hasClass("good-selected"))return e.removeClass("good-selected"),m.val(r),void G();if(e.hasClass("bad-selected"))return e.removeClass("bad-selected"),m.val(r),void G();e.hasClass("good-item")&&e.addClass("good-selected"),e.hasClass("bad-item")&&e.addClass("bad-selected"),m.val(""+i+a),G()}})},Q=function(){var e=o.create({auto:!0,swf:j,server:"/uc/comment/uploadpic",pick:"#j-upload-pic",compress:!1,accept:{title:"Images",extensions:"jpg,jpeg,bmp,png",mimeTypes:"image/*"}});e.on("beforeFileQueued",function(e){return _++,_>y?(_=y,this.trigger("error","file_count_exceed",e),!1):e.size>n?(this.trigger("error","file_size_exceed",e),!1):void h.text("")}),e.on("error",function(e){("file_size_exceed"==e||"file_count_exceed"==e)&&h.text(I[e])}),e.on("fileQueued",function(e){S.isUploadPic=!0;var t=8>_?13:0;$pic=$('<a href="javascript:;" class="thumb-img" id='+e.id+' style="margin-right:'+t+'px;"><img><span class="mask"></span><span class="closed j-pic-closed"></span></a>'),u.append($pic),8==_&&d.addClass("hide-pic-button")}),e.on("uploadProgress",function(e){var t=$("#"+e.id);t.find("img").attr("src",k)}),e.on("uploadAccept",function(e,t){return 0!=t.errno?!1:void 0}),e.on("uploadSuccess",function(t,a){var i=a.data,o=i.picUrl,n=i.picId,c=$("#"+t.id).find("img");c.attr("data-id",n),z.pic_list[n]=o,e.makeThumb(t,function(){c.attr("src",o)},s,r),M()}),e.on("uploadError",function(e){var t=$("#"+e.id);t.find("img").attr("src",C)}),e.on("uploadFinished",function(){S.isSuccess=!0})},H=function(){g=!0,u.on("click",".j-pic-closed",function(){var e=$(this),t=e.siblings("img"),a=t.attr("data-id");delete z.pic_list[a],e.parent().remove(),_--,7==_&&(d.removeClass("hide-pic-button"),u.find("a:last-child").css("margin-right","13px"),h.text(""))})},M=function(){_>0&&g===!1&&(picHandler=H())},V=function(){var e=u.find("img"),t=e.length;0!=t&&(_=t,e.each(function(e,t){var a=$(t),i=a.attr("data-id"),o=a.attr("src");z.pic_list[i]=o}),H())},X=function(e){U(),V(),P(e),N(),O(),E(),J(),Q(),Z()},q=function(e){z.score=e.score;for(var t=e.sub_score,a=0,i=t.length;i>a;a++){var o=t[a].itemId,n=t[a].score;z.item[o]=n}},B=function(e){for(var t=0,a=e.length;a>t;t++){var i=e[t],o=i.name,n=i.itemid,s=i.starmsg;x.push(n),F[n]={name:o,desc:s}}},K=function(){var e=document.title.split("#")[0];document.attachEvent("onpropertychange",function(t){t=t||window.event,"title"===t.propertyName&&document.title!==e&&setTimeout(function(){document.title=e},1)})},L=function(){var e;try{e=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(t){e="0.0"}return e=e.match(/\d+/g),parseFloat(e[0]+"."+e[1],10)},R=function(e){var a=L(),i=$.browser.msie&&$.browser.version<10;if(!a&&i){var n=['<div class="p-info-tip">',"没有安装flash player播放器,请下载安装",'<a href="http://www.adobe.com/go/getflashplayer" target="_blank" border="0">','<img alt="get flash player" src="http://www.adobe.com/macromedia/style_guide/images/160x41_Get_Flash_Player.jpg" />',"</a>","</div>"].join("");return void T(t,n)}if(!o.Uploader.support("flash")&&i){window.expressinstallcallback=function(e){switch(e){case"Download.Cancelled":alert("您取消了更新！");break;case"Download.Failed":alert("安装失败");break;default:alert("安装已成功，请刷新！")}delete window.expressinstallcallback};var s="/static/widget/lib/webuploader/expressInstall.swf",n='<object type="application/x-shockwave-flash" data="'+s+'"';return o.browser.ie&&(n+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"'),n+='style="position:absolute;width:100%;height:100%;left:0;top:0;z-index:999;outline:0"><param name="movie" value="'+s+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>',$("body").append(n),void $("html").scrollTop(0)}i&&K(),A(e),W()},W=function(){var e={catg_ids:z.catg_ids,dealId:z.dealId,orderId:z.orderId,timestamp:(new Date).getTime()};$.get(l.detail,e,function(e){var e=$.parseJSON(e),i=e.errno;if(0==i){var o=e.data,n=o.doc.item,s=o.comment_type,r=o.html,c=1==s?"发表评论":"修改评论";2==s&&q(o.detail),B(n),T(a,r,c),X(s)}else{var r='<div class="error-info-tip">'+e.msg+"</div>";T(t,r)}})},Y=function(){if(0===z.score)throw{error_msg:I.score};for(var e=0,t=x.length;t>e;e++){var a=x[e];if(!z.item[a])throw{error_msg:"请输入"+F[a].name+"的评分！"}}var i=m.val();if(z.content=i,i.length>c)throw{error_msg:I.content};if(S.isUploadPic&&S.isSuccess===!1)throw{error_msg:I.upload}},Z=function(){w.on("click",function(){try{Y()}catch(e){var t=e.error_msg;return void h.text(t)}delete z.catg_ids,$.post(l.submit,z,function(e){var e=$.parseJSON(e),t=e.data.html;b.hide();var o={width:a,content:t,title:"提示",timeout:5e3,mask:{enable:!0,zIndex:100,opacity:.3,backgroundColor:"#000"},onhide:function(){window.location.reload()}};i.splash(o)})})};return{init:function(e){R(e)}}}();a.exports={init:n.init}});